<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Disaster Incident Reporting System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* तुझा जुना CSS कोड तसाच राहू दे */
        :root{ --primary:#0b5ed7; --primary-dark:#084298; --bg:#f0f2f6; --radius:14px; --success:#28a745; --danger:#dc3545; }
        *{box-sizing:border-box;font-family:'Segoe UI',Arial,sans-serif}
        body{ margin:0; background:var(--bg); }
        header{ display:flex; justify-content:space-between; align-items:center; padding:16px 20px; background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:#fff; }
        header h1{font-size:18px; margin:0; flex:1; text-align:center;}
        .main{ max-width:900px; margin:20px auto; padding:0 15px; }
        .card{ background:#fff; border-radius:var(--radius); box-shadow:0 20px 40px rgba(0,0,0,.1); overflow:hidden; }
        .card-header{ padding:20px; background:linear-gradient(135deg,var(--primary),var(--primary-dark)); color:#fff; }
        form{padding:20px}
        .section{ margin-bottom:25px; padding:16px; border-radius:var(--radius); border:1px solid #e2e8f0; background:#fafafa; }
        .grid{ display:grid; grid-template-columns:1fr; gap:14px; }
        @media(min-width:700px){ .grid{grid-template-columns:1fr 1fr} }
        .field{display:flex;flex-direction:column; margin-bottom:10px;}
        input,select,textarea{ padding:12px; border-radius:10px; border:1px solid #ccc; }
        #map{ height:300px; width:100%; border-radius:12px; margin-top:10px; }
        .btn-primary{ background:var(--primary); color:#fff; padding:12px; border:none; border-radius:12px; font-weight:700; cursor:pointer; width:100%; }
        
        /* Modal Styles */
        #popupModal{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center; }
        .modal-content{ background:#fff; padding:25px; border-radius:16px; max-width:400px; width:90%; text-align:center; }
    </style>
</head>
<body>

<header>
    <i class="fas fa-arrow-left"></i>
    <h1>Disaster Rescue Management</h1>
    <i class="fas fa-bell"></i>
</header>

<div class="main">
    <div class="card">
        <div class="card-header">
            <h2>Disaster Incident Report</h2>
            <p>Report emergency incidents accurately</p>
        </div>

        <form id="reportForm">
            <div class="section">
                <div class="grid">
                    <div class="field">
                        <label>Full Name *</label>
                        <input name="fullname" id="fullname" required>
                    </div>
                    <div class="field">
                        <label>Mobile Number *</label>
                        <input type="tel" name="mobile" id="mobile" required>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="grid">
                    <div class="field">
                        <label>Disaster Type *</label>
                        <select name="disasterType" id="disasterType" required>
                            <option value="">Select</option>
                            <option>Flood</option>
                            <option>Fire</option>
                            <option>Earthquake</option>
                            <option>Cyclone</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Date & Time *</label>
                        <input type="datetime-local" id="datetimeInput" required>
                    </div>
                    <div class="field" style="grid-column:1/-1">
                        <label>Live Location</label>
                        <input id="locationInput" readonly required>
                        <div id="map"></div>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn-primary">Submit Report</button>
        </form>
    </div>
</div>

<div id="popupModal">
    <div class="modal-content">
        <h3>✅ Success!</h3>
        <p>Your report has been sent to the admin dashboard.</p>
        <button onclick="closeMyModal()" style="width:100%; padding:10px; background:#28a745; color:#fff; border:none; border-radius:8px;">OK</button>
    </div>
</div>

<script>
// 1. SUPABASE CONFIG (Ithe tuze details tak)
const SUPABASE_URL = 'https://idogfmuksxbjjmrfdclk.supabase.co'; 
const SUPABASE_KEY = 'sb_publishable_49Wi0aMQU0u1YF4nF3PQvg_WbwUscRs';
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// 2. MAP & LOCATION LOGIC
let map, marker;
const locationInput = document.getElementById("locationInput");

function initMap(lat, lng) {
    map = L.map("map").setView([lat, lng], 15);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
    marker = L.marker([lat, lng], {draggable: true}).addTo(map);
    updateLocationText(lat, lng);

    marker.on("dragend", e => {
        const pos = e.target.getLatLng();
        updateLocationText(pos.lat, pos.lng);
    });
}

function updateLocationText(lat, lng) {
    locationInput.value = `Lat ${lat.toFixed(6)}, Lng ${lng.toFixed(6)}`;
}

navigator.geolocation.getCurrentPosition(
    p => initMap(p.coords.latitude, p.coords.longitude),
    () => initMap(19.0760, 72.8777)
);

// 3. FORM SUBMIT TO SUPABASE
const form = document.getElementById("reportForm");

form.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    // Data Object
    const reportData = {
        fullname: document.getElementById("fullname").value,
        mobile: document.getElementById("mobile").value,
        location: locationInput.value,
        datetime: document.getElementById("datetimeInput").value,
        // jar tuze columns "disasterType" asel tar te pan add kar
    };

    try {
        // 'Report' table madhe data insert kara
        const { error } = await _supabase
            .from('Report') 
            .insert([reportData]);

        if (error) throw error;

        // Success! Modal dakhva
        document.getElementById("popupModal").style.display = "flex";

    } catch (err) {
        console.error(err);
        alert("Error: " + err.message);
    }
});

function closeMyModal() {
    document.getElementById("popupModal").style.display = "none";
    form.reset();
}
</script>
</body>
</html>